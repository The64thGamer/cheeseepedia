{{- $currentPageTitle := .Title -}}

{{- /* Get reverse index: pageTitle -> []Pages */ -}}
{{- $photosByPage := partialCached "grab-photos-by-page.html" "photos-by-page" -}}

{{- /* Get the photos for this page (slice of Page objects) */ -}}
{{- $relevant := index $photosByPage $currentPageTitle | default (slice) -}}

{{- if gt (len $relevant) 0 -}}
  {{- /* Build sortable slice with sort key derived from .Params.startDate */ -}}
  {{- $photosSlice := slice -}}
  {{- range $relevant -}}
    {{- $p := . -}}
    {{- $date := $p.Params.startDate | default "9999-99-99" -}}
    {{- $parts := split $date "-" -}}
    {{- $year := index $parts 0 | default "9999" -}}
    {{- $month := index $parts 1 | default "99" -}}
    {{- $day := index $parts 2 | default "99" -}}
    {{- $sortKey := printf "%04s%02s%02s" $year $month $day -}}
    {{- $photosSlice = $photosSlice | append (dict "item" $p "key" $sortKey) -}}
  {{- end -}}

  {{- $photosSlice = sort $photosSlice "key" -}}

  <div class="gallery">
    {{- range $photosSlice -}}
      {{- $photo := .item -}}
      <div class="gallery-image-box">
        {{- $thumb := $photo.Params.title | default $photo.Title -}}
        {{- $mode := "default" -}}
        {{- partialCached "DisplayPhoto.html" (dict "name" $thumb "mode" $mode) (printf "%s|%s" $thumb $mode) -}}
      </div>
    {{- end -}}
  </div>
{{- end -}}
