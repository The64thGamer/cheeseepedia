{{- $currentPageTitle := .Title -}}

{{- /* Grab the map of all photos once */ -}}
{{- $allPhotos := partialCached "grab-all-photos.html" "all-photos-map" -}}

{{- /* Build a slice of photos with sort keys */ -}}
{{- $photosSlice := slice -}}
{{- range $key, $photo := $allPhotos -}}
  {{- $date := $photo.Params.startDate | default "9999-99-99" -}}
  {{- $parts := split $date "-" -}}
  {{- $year := index $parts 0 | default "9999" -}}
  {{- $month := index $parts 1 | default "99" -}}
  {{- $day := index $parts 2 | default "99" -}}
  {{- $sortKey := printf "%04s%02s%02s" $year $month $day -}}
  {{- $photosSlice = $photosSlice | append (dict "item" $photo "key" $sortKey) -}}
{{- end -}}

{{- $photosSlice = sort $photosSlice "key" -}}

{{- $hasGallery := 0 -}}
{{- $galleryOpen := false -}}

{{- range $photosSlice -}}
  {{- $photo := .item -}}
  {{- $matches := in $photo.Params.pages $currentPageTitle -}}

  {{- if $matches -}}
    {{- if eq $hasGallery 0 -}}
      <div class="gallery">
      {{- $galleryOpen = true -}}
    {{- end -}}
    {{- $hasGallery = add $hasGallery 1 -}}

    <div class="gallery-image-box">
      {{- /* Use partialCached keyed by file path */ -}}
      {{- partialCached "DisplayPhoto.html" (dict "name" $photo "mode" "default") $photo }}
    </div>
  {{- end -}}
{{- end -}}

{{- if $galleryOpen -}}
</div>
{{- end -}}
