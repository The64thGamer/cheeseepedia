{{- /*
  build-photo-indexes.html
  Builds three indexes from content/photos:
    - byTitle: filename/title -> Page
    - byPath:  .File.Path -> Page
    - byPage:  pageTitle -> slice of Page (photos that reference that page in .Params.pages)

  This is intended to be called via partialCached "build-photo-indexes.html" "photos-index"
*/ -}}

{{- $photos := where site.RegularPages "Section" "photos" -}}
{{- $byTitle := dict -}}
{{- $byPath  := dict -}}
{{- $byPage  := dict -}}

{{- range $photos -}}
  {{- /* canonical keys */ -}}
  {{- $titleKey := .Params.title | default .Title | printf "%s" -}}
  {{- $filePathKey := .File.Path | default "" | printf "%s" -}}

  {{- /* store page objects (merge preserves the Page object) */ -}}
  {{- $byTitle = merge $byTitle (dict $titleKey .) -}}
  {{- if ne $filePathKey "" -}}
    {{- $byPath = merge $byPath (dict $filePathKey .) -}}
  {{- end -}}

  {{- /* Build reverse index safely: handle .Params.pages being string OR slice */ -}}
  {{- $rawPages := .Params.pages -}}
  {{- $pagesList := slice -}}
  {{- if $rawPages -}}
    {{- $t := printf "%T" $rawPages -}}
    {{- if in $t "string" -}}
      {{- $pagesList = slice $rawPages -}}
    {{- else -}}
      {{- /* assume slice-like; default ensures non-nil */ -}}
      {{- $pagesList = default (slice) $rawPages -}}
    {{- end -}}
  {{- end -}}

  {{- range $p := $pagesList -}}
    {{- /* ensure existing is a slice (default to empty slice if absent) */ -}}
    {{- $existing := default (slice) (index $byPage $p) -}}
    {{- $byPage = merge $byPage (dict $p (append $existing .)) -}}
  {{- end -}}
{{- end -}}

{{- return (dict "byTitle" $byTitle "byPath" $byPath "byPage" $byPage) -}}
