{{- /* layouts/partials/build-photo-indexes.html */ -}}

{{- $site := .Site -}}
{{- if not $site -}}
  {{- $site = . -}}
{{- end -}}

{{- $photos := where $site.RegularPages "Section" "photos" -}}
{{- $byPage := dict -}}

{{- range $p := $photos -}}
  {{- $raw := $p.Params.pages | default (slice) -}}
  {{- $pagesList := slice -}}
  {{- /* normalize */ -}}
  {{- range $v := $raw -}}
    {{- $pagesList = $pagesList | append (printf "%s" $v) -}}
  {{- end -}}

  {{- range $title := $pagesList -}}
    {{- $existing := index $byPage $title | default (slice) -}}
    {{- /* dedupe by RelPermalink */ -}}
    {{- $found := where $existing "RelPermalink" $p.RelPermalink -}}
    {{- if eq (len $found) 0 -}}
      {{- $byPage = merge $byPage (dict $title (append $existing $p))) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- return $byPage -}}
