{{- $site := .Site -}}

{{- $photos := where $site.RegularPages "Section" "photos" -}}
{{- $byPage := dict -}}

{{- range $p := $photos -}}
  {{- $pageRefs := $p.Params.pages | default (slice) -}}
  {{- /* Normalize pageRefs to a slice of strings */ -}}
  {{- $normalized := slice -}}
  {{- range $r := $pageRefs -}}
    {{- $normalized = $normalized | append (printf "%s" $r) -}}
  {{- end -}}

  {{- range $title := $normalized -}}
    {{- $existing := index $byPage $title | default (slice) -}}
    {{- /* dedupe by RelPermalink */ -}}
    {{- $found := where $existing "RelPermalink" $p.RelPermalink -}}
    {{- if eq (len $found) 0 -}}
      {{- $byPage = merge $byPage (dict $title (append $existing $p))) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- return $byPage -}}
