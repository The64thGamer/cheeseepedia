{{- /*
DisplayPhoto.html
Params:
  .name - filename string (e.g. "blah.avif")
  .mode - "default", "no-css", "no-css-no-desc", "no-css-file-link", "no-link"
Usage example (preferred):
  {{ partialCached "DisplayPhoto.html" (dict "name" "blah.avif" "mode" "no-css") "blah.avif" }}
*/ -}}

{{- $ctxName := (.name | default "") | printf "%s" -}}   {{/* force string */}}
{{- $ctxMode := (.mode | default "default") | printf "%s" -}}

{{- /* immediate short-circuit for empty name */ -}}
{{- if eq $ctxName "" -}}
  {{- if in (slice "no-link" "no-css-no-desc") $ctxMode -}}
    <img src="/UI/File Not Found.jpg" alt="File Not Found.jpg" />
  {{- else -}}
    <div class="article-photo-image">
      <a href="#">
        <img src="/UI/File Not Found.jpg" alt="File Not Found.jpg" />
      </a>
    </div>
    {{- if ne $ctxMode "no-css-no-desc" -}}
      <div class="article-photo-description">File Not Found</div>
    {{- end -}}
  {{- end -}}
  {{- return -}}
{{- end -}}

{{- /* fetch the combined indexes (cached inside) */ -}}
{{- $idx := partialCached "build-photo-indexes.html" "photos-index" -}}
{{- $byTitle := index $idx "byTitle" -}}
{{- $byPath  := index $idx "byPath" -}}

{{- /* Try title lookup first (typical), fallback to path lookup if the caller passed a path */ -}}
{{- $page := index $byTitle $ctxName -}}
{{- if not $page -}}
  {{- $page = index $byPath $ctxName -}}
{{- end -}}

{{- /* compute image URL by checking static/photos/<filename> */ -}}
{{- $imgURL := "/UI/File Not Found.jpg" -}}
{{- $alt := $ctxName -}}
{{- $filePath := printf "static/photos/%s" $ctxName -}}
{{- if fileExists $filePath -}}
  {{- $imgURL = printf "/photos/%s" $ctxName -}}
{{- end -}}

{{- /* if we have a page, use nicer alt and date */ -}}
{{- $dateStr := "" -}}
{{- if $page -}}
  {{- $alt = ($page.Content | plainify) | default $ctxName -}}
  {{- with $page.Params.startDate -}}
    {{- $dateStr = partial "Readable_Date.html" (dict "date" . "presentOnEmpty" false) -}}
  {{- end -}}
{{- end -}}

{{- /* Render modes (kept identical to previous semantics) */ -}}
{{- if eq $ctxMode "no-css-file-link" -}}
  <a href="{{- if $page -}}{{ printf "/photos/%s" $ctxName }}{{- else -}}#{{- end -}}">
    <img data-pagefind-meta="image[src], image_alt[alt]" src="{{- $imgURL -}}" alt="{{- $alt -}}" />
  </a>
  <div class="article-photo-description">
    {{- if $page -}}{{ $page.Content }}{{- if $dateStr -}} ({{ $dateStr }}){{- end -}}{{- else -}}{{ $ctxName }}{{- end -}}
  </div>

{{- else if eq $ctxMode "no-css-no-desc" -}}
  <a href="{{- if $page -}}{{ $page.RelPermalink }}{{- else -}}#{{- end -}}">
    <img data-pagefind-meta="image[src], image_alt[alt]" src="{{- $imgURL -}}" alt="{{- $alt -}}" />
  </a>

{{- else if eq $ctxMode "no-css" -}}
  <a href="{{- if $page -}}{{ $page.RelPermalink }}{{- else -}}#{{- end -}}">
    <img data-pagefind-meta="image[src], image_alt[alt]" src="{{- $imgURL -}}" alt="{{- $alt -}}" />
  </a>
  <div class="article-photo-description">
    {{- if $page -}}{{ $page.Content }}{{- if $dateStr -}} ({{ $dateStr }}){{- end -}}{{- else -}}{{ $ctxName }}{{- end -}}
  </div>

{{- else if eq $ctxMode "no-link" -}}
  <img src="{{- $imgURL -}}" alt="{{- $alt -}}" />

{{- else -}}  {{/* default */}}
  <div class="article-photo-image">
    <a href="{{- if $page -}}{{ $page.RelPermalink }}{{- else -}}#{{- end -}}">
      <img src="{{- $imgURL -}}" alt="{{- $alt -}}" />
    </a>
  </div>
  <div class="article-photo-description">
    {{- if $page -}}{{ $page.Content }}{{- if $dateStr -}} ({{ $dateStr }}){{- end -}}{{- else -}}{{ $ctxName }}{{- end -}}
  </div>
{{- end -}}
