{{- /*
DisplayPhoto.html â€” fast, stable, per-photo lookup
- Prefers site.Data.photos (data/photos.json)
- Falls back to site.Data.photosbypage (data/photosbypage.json) by building a tiny map
Params:
  .name - photo filename/title (e.g. "blah.avif")
  .mode - "default", "no-css", "raw-photo"
*/ -}}

{{- $ctxName := (.name | default "") | printf "%s" -}}
{{- $ctxMode := (.mode | default "default") | printf "%s" -}}

{{- /* === Build / select meta source === */ -}}
{{- $metaMap := dict -}}

{{- with site.Data.photos -}}
  {{- $metaMap = . -}}
{{- else -}}
  {{- with site.Data.photosbypage -}}
    {{- range $pageKey, $arr := . -}}
      {{- range $i, $m := $arr -}}
        {{- $n := index $m "name" | default "" -}}
        {{- if ne $n "" -}}
          {{- $entry := dict
              "name" (index $m "name")
              "hasFile" (index $m "hasFile")
              "fileName" (index $m "fileName")
              "startDate" (index $m "startDate")
              "page_path" (index $m "page_path")
              "content" (index $m "content")
              "pages" (index $m "pages")
          -}}
          {{- $metaMap = merge $metaMap (dict $n $entry) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* === Lookup metadata for this photo === */ -}}
{{- $m := index $metaMap $ctxName -}}

{{- /* === Image URL / hasFile fallback === */ -}}
{{- $imgURL := printf "/photos/%s" $ctxName -}}
{{- $lowResURL := printf "/lowphotos/%s" $ctxName -}}
{{- $hasFile := false -}}
{{- if $m -}}
  {{- $hasFile = index $m "hasFile" | default false -}}
{{- end -}}

{{- /* === Description and formatted date === */ -}}
{{- $desc := "" -}}
{{- $dateStr := "" -}}
{{- if $m -}}
  {{- with index $m "content" -}}
      {{- $desc = . -}}
  {{- end -}}
  {{- with index $m "startDate" -}}
    {{- if ne . "" -}}
      {{- $dateStr = partial "Readable_Date.html" (dict "date" . "presentOnEmpty" false) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $linkURL := "#" -}}
{{- if $m -}}
  {{- $raw := (index $m "page_path") | default "" -}}
  {{- if ne $raw "" -}}
    {{- $p1 := replace $raw "content/" "" -}}
    {{- $p2 := replaceRE "\\.md$" "" $p1 -}}
    {{- $linkURL = printf "/%s/" $p2 -}}
  {{- end -}}
{{- end -}}

{{- $altText := cond (ne $desc "") $desc $ctxName -}}
{{- $displayText := cond (ne $desc "") (printf "%s%s" $desc (cond (ne $dateStr "") (printf " (%s)" $dateStr) "")) (cond (ne $ctxName "") (replace $ctxName "_" " ") "File Not Found") -}}

{{- $notFoundPath := "/UI/File Not Found.jpg" -}}
{{- if or (eq $ctxName "") (not $m) (not $hasFile) -}}
  {{- $imgURL = $notFoundPath -}}
  {{- $lowResURL = $notFoundPath -}}
  {{- $altText = "File Not Found" -}}
  {{- $displayText = "File Not Found" -}}
{{- end -}}

{{- /* === Render according to mode with lazy-loading === */ -}}
{{- if eq "no-css" $ctxMode -}}
  <a href="{{ $linkURL }}">
    <img src="{{ $lowResURL }}" data-src="{{ $imgURL }}" alt="{{ $altText }}" class="lazy-photo" loading="lazy" />
  </a>
  <div class="article-photo-description">{{ $displayText }}</div>
{{- else if eq $ctxMode "raw-photo" -}}
  <img src="{{ $lowResURL }}" data-src="{{ $imgURL }}" alt="{{ $altText }}" class="lazy-photo" loading="lazy" />
{{- else -}}
  <div class="article-photo-image">
    <a href="{{ $linkURL }}">
      <img src="{{ $lowResURL }}" data-src="{{ $imgURL }}" alt="{{ $altText }}" class="lazy-photo" loading="lazy" />
    </a>
  </div>
  <div class="article-photo-description">{{ $displayText }}</div>
{{- end -}}
