{{- /* DisplayPhoto.html — safe version */ -}}

{{- $ctxName := .name | default "" -}}
{{- $ctxMode := .mode | default "default" -}}

{{- /* Short-circuit: when name is empty */ -}}
{{- if eq $ctxName "" -}}
  {{- /* Render fallback image */ -}}
  {{- if in (slice "no-link" "no-css-no-desc") $ctxMode -}}
    <img src="/UI/File Not Found.jpg" alt="File Not Found.jpg" />
  {{- else -}}
    <div class="article-photo-image">
      <a href="#">
        <img src="/UI/File Not Found.jpg" alt="File Not Found.jpg" />
      </a>
    </div>
    {{- if ne $ctxMode "no-css-no-desc" -}}
      <div class="article-photo-description">File Not Found</div>
    {{- end -}}
  {{- end -}}
  {{- return }}  
{{- end -}}

{{- /* Load the photos map */ -}}
{{- $photos := partialCached "grab-all-photos.html" "all-photos-map" -}}

{{- /* Try to look up the page — use "with" to run only if found */ -}}
{{- with index $photos $ctxName }} 
  {{- $page := . -}}
  {{- /* Page exists — compute alt, url, date */ -}}
  {{- $alt := $page.Content | plainify | default $ctxName -}}
  {{- $filePath := printf "static/photos/%s" $ctxName -}}
  {{- $imgURL := "/UI/File Not Found.jpg" -}}
  {{- if fileExists $filePath -}}
    {{- $imgURL = printf "/photos/%s" $ctxName -}}
  {{- end -}}

  {{- $dateStr := "" -}}
  {{- with $page.Params.startDate }}
    {{- $dateStr = partial "Readable_Date.html" (dict "date" . "presentOnEmpty" false) -}}
  {{- end }}

  {{- /* Render by mode */ -}}
  {{- if eq $ctxMode "no-css-file-link" -}}
    <a href="{{ printf "/photos/%s" $ctxName }}">
      <img data-pagefind-meta="image[src], image_alt[alt]" src="{{ $imgURL }}" alt="{{ $alt }}" />
    </a>
    <div class="article-photo-description">
      {{- $page.Content -}}
      {{- if $dateStr -}} ({{ $dateStr }}){{- end -}}
    </div>

  {{- else if eq $ctxMode "no-css-no-desc" -}}
    <a href="{{ $page.RelPermalink }}">
      <img data-pagefind-meta="image[src], image_alt[alt]" src="{{ $imgURL }}" alt="{{ $alt }}" />
    </a>

  {{- else if eq $ctxMode "no-css" -}}
    <a href="{{ $page.RelPermalink }}">
      <img data-pagefind-meta="image[src], image_alt[alt]" src="{{ $imgURL }}" alt="{{ $alt }}" />
    </a>
    <div class="article-photo-description">
      {{- $page.Content -}}
      {{- if $dateStr -}} ({{ $dateStr }}){{- end -}}
    </div>

  {{- else if eq $ctxMode "no-link" -}}
    <img src="{{ $imgURL }}" alt="{{ $alt }}" />

  {{- else -}}  {{/* default */}}
    <div class="article-photo-image">
      <a href="{{ $page.RelPermalink }}">
        <img src="{{ $imgURL }}" alt="{{ $alt }}" />
      </a>
    </div>
    <div class="article-photo-description">
      {{- $page.Content -}}
      {{- if $dateStr -}} ({{ $dateStr }}){{- end -}}
    </div>
  {{- end -}}

{{- else -}}
  {{- /* Page not found in map — fallback */ -}}
  <img src="/UI/File Not Found.jpg" alt="{{ $ctxName }}" />
{{- end -}}
