{{- /*
Fast DisplayPhoto.html (fixed: include content + format date)
Params:
  .name - filename/title string (e.g. "blah.avif")
  .mode - "default", "no-css", "no-css-no-desc", "no-css-file-link", "no-link"
Behavior:
  - Uses site.Data.photos-by-page if present (cheap)
  - Reads content and startDate from the meta and renders them
  - Uses markdownify for content so wiki/markdown links render
*/ -}}

{{- $ctxName := (.name | default "") | printf "%s" -}}
{{- $ctxMode := (.mode | default "default") | printf "%s" -}}

{{- /* Build tiny metaMap from site.Data.photos-by-page if available */ -}}
{{- $metaMap := dict -}}
{{- with site.Data.photos-by-page -}}
  {{- range $pageKey, $arr := . -}}
    {{- range $i, $m := $arr -}}
      {{- $n := index $m "name" | default "" -}}
      {{- if ne $n "" -}}
        {{- $metaMap = merge $metaMap (dict $n (dict
            "imageURL" (index $m "imageURL")
            "hasFile"  (index $m "hasFile")
            "fileName" (index $m "fileName")
            "startDate" (index $m "startDate")
            "page_path" (index $m "page_path")
            "content"   (index $m "content")
        )) ) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Determine image URL and hasFile (prefer metaMap when present) */ -}}
{{- $imgURL := "/UI/File Not Found.jpg" -}}
{{- $hasFile := false -}}
{{- if ne $ctxName "" -}}
  {{- $m := index $metaMap $ctxName -}}
  {{- if $m -}}
    {{- $imgURL = index $m "imageURL" | default $imgURL -}}
    {{- $hasFile = index $m "hasFile" | default false -}}
  {{- else -}}
    {{- $imgURL = printf "/photos/%s" $ctxName -}}
  {{- end -}}
{{- end -}}

{{- /* Derive alt/description/date from metaMap if present */ -}}
{{- $alt := $ctxName -}}
{{- $desc := "" -}}
{{- $dateStr := "" -}}
{{- if (index $metaMap $ctxName) -}}
  {{- $md := index $metaMap $ctxName -}}
  {{- with (index $md "content") -}}
    {{- $desc = . -}}
  {{- end -}}
  {{- with (index $md "startDate") -}}
    {{- /* Format date using your existing partial for consistency */ -}}
    {{- $dateStr = partial "Readable_Date.html" (dict "date" . "presentOnEmpty" false) -}}
  {{- end -}}
{{- end -}}

{{- /* link URL: keep as # for now; later you can use page_path->RelPermalink mapping */ -}}
{{- $linkURL := "#" -}}

{{- /* Render according to mode */ -}}
{{- if eq $ctxMode "default" -}}
  <div class="article-photo-image">
    <a href="{{ $linkURL }}">
      <img src="{{ $imgURL }}" alt="{{ $alt }}" data-pagefind-meta="image[src], image_alt[alt]" loading="lazy" />
    </a>
  </div>
  <div class="article-photo-description">
    {{- if ne $desc "" -}}
      {{- /* render body as markdown/html */ -}}
      {{- $desc | markdownify | safeHTML -}}
      {{- if $dateStr -}} ({{ $dateStr }}){{- end -}}
    {{- else -}}
      {{- if ne $ctxName "" -}}
        {{- $clean := replace $ctxName "_" " " | replaceRE "\\.(?i)(avif|jpg|jpeg|png|gif)$" "" -}}
        {{- $clean -}}
      {{- else -}}
        File Not Found
      {{- end -}}
    {{- end -}}
  </div>

{{- else if eq $ctxMode "no-css-file-link" -}}
  <a href="{{ $linkURL }}">
    <img loading="lazy" data-pagefind-meta="image[src], image_alt[alt]" src="{{ $imgURL }}" alt="{{ $alt }}" />
  </a>
  <div class="article-photo-description">
    {{- if ne $desc "" -}}{{- $desc | markdownify | safeHTML -}}{{- if $dateStr -}} ({{ $dateStr }}){{- end -}}{{- else -}}{{- $ctxName -}}{{- end -}}
  </div>

{{- else if eq $ctxMode "no-css-no-desc" -}}
  <a href="{{ $linkURL }}">
    <img loading="lazy" data-pagefind-meta="image[src], image_alt[alt]" src="{{ $imgURL }}" alt="{{ $alt }}" />
  </a>

{{- else if eq $ctxMode "no-css" -}}
  <a href="{{ $linkURL }}">
    <img loading="lazy" data-pagefind-meta="image[src], image_alt[alt]" src="{{ $imgURL }}" alt="{{ $alt }}" />
  </a>
  <div class="article-photo-description">
    {{- if ne $desc "" -}}{{- $desc | markdownify | safeHTML -}}{{- if $dateStr -}} ({{ $dateStr }}){{- end -}}{{- else -}}{{- $ctxName -}}{{- end -}}
  </div>

{{- else if eq $ctxMode "no-link" -}}
  <img loading="lazy" src="{{ $imgURL }}" alt="{{ $alt }}" data-pagefind-meta="image[src], image_alt[alt]" />

{{- else -}}
  <div class="article-photo-image">
    <a href="{{ $linkURL }}">
      <img loading="lazy" src="{{ $imgURL }}" alt="{{ $alt }}" data-pagefind-meta="image[src], image_alt[alt]" />
    </a>
  </div>
  <div class="article-photo-description">
    {{- if ne $desc "" -}}{{- $desc | markdownify | safeHTML -}}{{- if $dateStr -}} ({{ $dateStr }}){{- end -}}{{- else -}}{{- $ctxName -}}{{- end -}}
  </div>
{{- end -}}
