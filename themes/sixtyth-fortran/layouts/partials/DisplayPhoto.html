{{- /*
DisplayPhoto.html (uses the build-photo-indexes meta)
Params:
  .name - filename string (e.g. "blah.avif")
  .mode - "default", "no-css", "no-css-no-desc", "no-css-file-link", "no-link"
Usage:
  {{ partialCached "DisplayPhoto.html" (dict "name" $thumb "mode" "no-css") $thumb }}
*/ -}}

{{- $ctxName := (.name | default "") | printf "%s" -}}
{{- $ctxMode := (.mode | default "default") | printf "%s" -}}

{{- if eq $ctxName "" -}}
  {{- if in (slice "no-link" "no-css-no-desc") $ctxMode -}}
    <img src="/UI/File Not Found.jpg" alt="File Not Found.jpg" />
  {{- else -}}
    <div class="article-photo-image">
      <a href="#">
        <img src="/UI/File Not Found.jpg" alt="File Not Found.jpg" />
      </a>
    </div>
    {{- if ne $ctxMode "no-css-no-desc" -}}
      <div class="article-photo-description">File Not Found</div>
    {{- end -}}
  {{- end -}}
  {{- return -}}
{{- end -}}

{{- /* Fetch indexes (cached). build-photo-indexes returns a dict with meta */ -}}
{{- $idx := partialCached "build-photo-indexes.html" "photos-index" -}}
{{- $byTitle := index $idx "byTitle" -}}
{{- $byPath  := index $idx "byPath" -}}
{{- $metaMap := index $idx "meta" -}}

{{- /* Lookup page: try title, then path */ -}}
{{- $page := index $byTitle $ctxName -}}
{{- if not $page -}}
  {{- $page = index $byPath $ctxName -}}
{{- end -}}

{{- /* Lookup precomputed meta (imageURL) */ -}}
{{- $m := index $metaMap $ctxName -}}
{{- $imgURL := "/UI/File Not Found.jpg" -}}
{{- $hasFile := false -}}
{{- if $m -}}
  {{- $imgURL = index $m "imageURL" | default $imgURL -}}
  {{- $hasFile = index $m "hasFile" | default false -}}
{{- else -}}
  {{- /* As a fallback, check file existence once */ -}}
  {{- if fileExists (printf "static/photos/%s" $ctxName) -}}
    {{- $imgURL = printf "/photos/%s" $ctxName -}}
    {{- $hasFile = true -}}
  {{- end -}}
{{- end -}}

{{- $alt := $ctxName -}}
{{- $dateStr := "" -}}
{{- if $page -}}
  {{- $alt = ($page.Content | plainify) | default $ctxName -}}
  {{- with $page.Params.startDate -}}
    {{- $dateStr = partial "Readable_Date.html" (dict "date" . "presentOnEmpty" false) -}}
  {{- end -}}
{{- end -}}

{{- /* Render modes */ -}}
{{- if eq $ctxMode "no-css-file-link" -}}
  <a href="{{- if $page -}}{{ printf "/photos/%s" $ctxName }}{{- else -}}#{{- end -}}">
    <img data-pagefind-meta="image[src], image_alt[alt]" src="{{- $imgURL -}}" alt="{{- $alt -}}" />
  </a>
  <div class="article-photo-description">
    {{- if $page -}}{{ $page.Content }}{{- if $dateStr -}} ({{ $dateStr }}){{- end -}}{{- else -}}{{ $ctxName }}{{- end -}}
  </div>

{{- else if eq $ctxMode "no-css-no-desc" -}}
  <a href="{{- if $page -}}{{ $page.RelPermalink }}{{- else -}}#{{- end -}}">
    <img data-pagefind-meta="image[src], image_alt[alt]" src="{{- $imgURL -}}" alt="{{- $alt -}}" />
  </a>

{{- else if eq $ctxMode "no-css" -}}
  <a href="{{- if $page -}}{{ $page.RelPermalink }}{{- else -}}#{{- end -}}">
    <img data-pagefind-meta="image[src], image_alt[alt]" src="{{- $imgURL -}}" alt="{{- $alt -}}" />
  </a>
  <div class="article-photo-description">
    {{- if $page -}}{{ $page.Content }}{{- if $dateStr -}} ({{ $dateStr }}){{- end -}}{{- else -}}{{ $ctxName }}{{- end -}}
  </div>

{{- else if eq $ctxMode "no-link" -}}
  <img src="{{- $imgURL -}}" alt="{{- $alt -}}" />

{{- else -}}
  <div class="article-photo-image">
    <a href="{{- if $page -}}{{ $page.RelPermalink }}{{- else -}}#{{- end -}}">
      <img src="{{- $imgURL -}}" alt="{{- $alt -}}" />
    </a>
  </div>
  <div class="article-photo-description">
    {{- if $page -}}{{ $page.Content }}{{- if $dateStr -}} ({{ $dateStr }}){{- end -}}{{- else -}}{{ $ctxName }}{{- end -}}
  </div>
{{- end -}}
