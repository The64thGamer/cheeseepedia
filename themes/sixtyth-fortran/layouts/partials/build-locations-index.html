{{/* build-locations-index.html
   Returns a dict keyed by "<paramName>|<LocationTitle>" -> slice of entries
   Each entry: dict "page" (the page object), "parts" (slice of parts), "sort" (sortable key)
*/}}

{{- $index := dict -}}

{{/* Adjust this filter to only scan the sections you need to speed up builds.
   e.g. where site.RegularPages "Section" "locations" or "Section" "articles" */}}
{{- $pages := site.RegularPages -}}

{{- /* list of param names we want to index */ -}}
{{- $paramNames := slice "animatronics" "attractions" "stages" "remodels" -}}

{{- range $p := $pages -}}
  {{- /* skip pages with no Params at all */ -}}
  {{- if $p.Params -}}
    {{- range $paramName := $paramNames -}}
      {{- $entries := index $p.Params $paramName -}}
      {{- if $entries -}}
        {{- range $entry := $entries -}}
          {{- /* parts = split on '|' */ -}}
          {{- $parts := split $entry "|" -}}
          {{- $name := trim (index $parts 0) " " -}}

          {{- /* Strict exact-match key uses the name field as provided */ -}}
          {{- if ne $name "" -}}
            {{- /* Extract start date for sorting; normalize missing/zero fields */ -}}
            {{- $start := "" -}}
            {{- if ge (len $parts) 2 -}}{{- $start = index $parts 1 -}}{{- end -}}
            {{- $s := $start | default "9999-99-99" -}}
            {{- $sp := split $s "-" -}}
            {{- $year := (index $sp 0) | default "9999" -}}
            {{- $month := (index $sp 1) | default "99" -}}
            {{- $day := (index $sp 2) | default "99" -}}

            {{- if eq $year "0000" }}{{ $year = "9999" }}{{ end -}}
            {{- if eq $month "00" }}{{ $month = "99" }}{{ end -}}
            {{- if eq $day "00" }}{{ $day = "99" }}{{ end -}}

            {{- $sortKey := printf "%04s%02s%02s" $year $month $day -}}

            {{- /* build entry dict */ -}}
            {{- $entryDict := dict "page" $p "parts" $parts "sort" $sortKey -}}

            {{- /* map key: paramName|LocationTitle */ -}}
            {{- $mapKey := printf "%s|%s" $paramName $name -}}

            {{- $existing := index $index $mapKey -}}
            {{- if $existing -}}
              {{- $newSlice := $existing | append $entryDict -}}
              {{- $index = merge $index (dict $mapKey $newSlice) -}}
            {{- else -}}
              {{- $index = merge $index (dict $mapKey (slice $entryDict)) -}}
            {{- end -}}

          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- return $index -}}
