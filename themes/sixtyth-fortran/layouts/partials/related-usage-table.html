{{- $currentTitle := .Title -}}
{{- $tags := .Params.tags | default (slice) -}}
{{- $paramName := "" -}}

{{- if in $tags "Animatronics" -}}
  {{- $paramName = "animatronics" -}}
{{- else if in $tags "Arcades and Attractions" -}}
  {{- $paramName = "attractions" -}}
{{- else if in $tags "Stage Variations" -}}
  {{- $paramName = "stages" -}}
{{- else if in $tags "Remodels and Initiatives" -}}
  {{- $paramName = "remodels" -}}
{{- end -}}

{{- if ne $paramName "" -}}

  {{/* Fetch the prebuilt index (cached).
      The second arg is the context (we pass .), the third is the cache key.
      Bump the cache key when you change the partial. */}}
  {{- $index := partialCached "build-locations-index.html" . "locations-index-v1" -}}

  {{- $mapKey := printf "%s|%s" $paramName $currentTitle -}}
  {{- $entriesList := index $index $mapKey | default (slice) -}}

  {{- /* Sort by sort key (the partial already built the sort key) */ -}}
  {{- $sorted := sort $entriesList "sort" -}}

  {{- if gt (len $sorted) 0 -}}
    <h2>Installations</h2>
    <table class="related-usage-table" aria-label="Related usage table">
      <thead>
        <tr>
          <th>Location</th>
          <th>{{ if eq $paramName "remodels" }}Installed{{ else }}Operating Dates{{ end }}</th>

          {{- if eq $paramName "stages" -}}
            <th>Version</th>
          {{- else if eq $paramName "animatronics" -}}
            <th>Serial Number</th>
            <th>Notes</th>
          {{- else if eq $paramName "remodels" -}}
            {{/* no additional columns for remodels */}}
          {{- else -}}
            <th>Notes</th>
          {{- end -}}

        </tr>
      </thead>

      <tbody>

      {{- range $sorted -}}
        {{- $other := .page -}}
        {{- $parts := .parts -}}

        <tr>
          <td><a href="{{ $other.RelPermalink }}">{{ $other.Title }}</a></td>

          <td>
            {{- $start := "" -}}
            {{- $end := "" -}}
            {{- if ge (len $parts) 2 -}}{{- $start = index $parts 1 -}}{{- end -}}
            {{- if ge (len $parts) 3 -}}{{- $end = index $parts 2 -}}{{- end -}}

            {{- if eq $paramName "remodels" -}}
              {{- partial "Readable_Date.html" (dict "date" $start "presentOnEmpty" false) -}}
            {{- else -}}
              {{- partial "Readable_Date.html" (dict "date" $start "presentOnEmpty" false) -}}{{- " - " -}}{{- partial "Readable_Date.html" (dict "date" $end "presentOnEmpty" true) -}}
            {{- end -}}
          </td>

          {{- if eq $paramName "animatronics" -}}
            <td>
              {{- if ge (len $parts) 4 -}}
                {{- trim (index $parts 3) " " -}}
              {{- else -}}
                &nbsp;
              {{- end -}}
            </td>

            <td>
              {{- $animNotes := slice -}}
              {{- range $i, $p := $parts -}}
                {{- if ge $i 4 -}}
                  {{- $animNotes = $animNotes | append (trim $p " ") -}}
                {{- end -}}
              {{- end -}}
              {{- if gt (len $animNotes) 0 -}}
                {{- delimit $animNotes " | " -}}
              {{- else -}}
                &nbsp;
              {{- end -}}
            </td>

          {{- else if eq $paramName "stages" -}}
            <td>
              {{- if ge (len $parts) 4 -}}
                {{- trim (index $parts 3) " " -}}
              {{- else -}}
                &nbsp;
              {{- end -}}
            </td>

          {{- else if eq $paramName "remodels" -}}
            {{- /* no extra columns */ -}}
          {{- else -}}
            <td>
              {{- $notesStr := "" -}}
              {{- range $i, $p := $parts -}}
                {{- if ge $i 3 -}}
                  {{- $trim := trim $p " " -}}
                  {{- if eq $notesStr "" -}}
                    {{- $notesStr = $trim -}}
                  {{- else -}}
                    {{- $notesStr = printf "%s | %s" $notesStr $trim -}}
                  {{- end -}}
                {{- end -}}
              {{- end -}}
              {{- if ne $notesStr "" -}}
                {{- $notesStr -}}
              {{- else -}}
                &nbsp;
              {{- end -}}
            </td>
          {{- end }}

        </tr>
      {{- end -}}

      </tbody>
    </table>
  {{- end -}}

{{- end -}}
