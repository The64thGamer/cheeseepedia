{{- $currentTitle := .Title -}}
{{- $tags := .Params.tags | default (slice) -}}
{{- $paramName := "" -}}

{{- if in $tags "Animatronics" -}}
  {{- $paramName = "animatronics" -}}
{{- else if in $tags "Arcades and Attractions" -}}
  {{- $paramName = "attractions" -}}
{{- else if in $tags "Stage Variations" -}}
  {{- $paramName = "stages" -}}
{{- else if in $tags "Remodels and Initiatives" -}}
  {{- $paramName = "remodels" -}}
{{- end -}}

{{- if ne $paramName "" -}}
  {{- $allPages := partialCached "grab-all-wiki-articles.html" . -}}
  {{- $foundAny := false -}}

  <h2>Installations</h2>

  <table class="related-usage-table" aria-label="Related usage table">
    <thead>
      <tr>
        <th>Location</th>
        <th>Operating Dates</th>

        {{- if eq $paramName "stages" -}}
          <th>Version</th>
        {{- else if eq $paramName "animatronics" -}}
          <th>Serial Number</th>
          <th>Notes</th>
        {{- else -}}
          <th>Notes</th>
        {{- end -}}

      </tr>
    </thead>

    <tbody>
    {{- range $allPages -}}
      {{- $other := . -}}
      {{- if ne $other.Title $currentTitle -}}
        {{- $entries := index $other.Params $paramName -}}
        {{- if $entries -}}
          {{- range $entries -}}
            {{- $parts := split . "|" -}}
            {{- $name := trim (index $parts 0) " " -}}

            {{- if or (eq $name $currentTitle) (strings.Contains $name $currentTitle) (strings.Contains $currentTitle $name) -}}
              {{- $foundAny = true -}}

              <tr>
                <!-- LOCATION -->
                <td><a href="{{ $other.RelPermalink }}">{{ $other.Title }}</a></td>

                <!-- OPERATING DATES -->
                <td>
                  {{- $start := "" -}}
                  {{- $end := "" -}}
                  {{- if ge (len $parts) 2 -}}{{- $start = index $parts 1 -}}{{- end -}}
                  {{- if ge (len $parts) 3 -}}{{- $end = index $parts 2 -}}{{- end -}}

                  {{- $validStart := and (ne $start "") (ne $start "0000-00-00") -}}
                  {{- $validEnd := and (ne $end "") (ne $end "0000-00-00") -}}

                  {{- if $validStart -}}
                    {{- partial "date-to-readable-date.html" $start -}}
                    {{- if $validEnd -}}
                      {{- " – " -}}
                      {{- partial "date-to-readable-date.html" $end -}}
                    {{- else if eq $end "0000-00-00" -}}
                      {{- " – Present" -}}
                    {{- end -}}
                  {{- else if $validEnd -}}
                    {{- partial "date-to-readable-date.html" $end -}}
                  {{- else if eq $end "0000-00-00" -}}
                    Present
                  {{- else -}}
                    —
                  {{- end -}}
                </td>

                <!-- EXTRA FIELDS -->
                {{- if eq $paramName "animatronics" -}}
                  <!-- SERIAL NUMBER (4th pipe piece) -->
                  <td>
                    {{- if ge (len $parts) 4 -}}
                      {{- trim (index $parts 3) " " -}}
                    {{- else -}}
                      &nbsp;
                    {{- end -}}
                  </td>

                <!-- NOTES (from 5th pipe onward) -->
                <td>
                {{- $animNotes := slice -}}
                {{- range $i, $p := $parts -}}
                    {{- if ge $i 4 -}}
                    {{- $animNotes = $animNotes | append (trim $p " ") -}}
                    {{- end -}}
                {{- end -}}
                {{- if gt (len $animNotes) 0 -}}
                    {{- delimit $animNotes " | " -}}
                {{- else -}}
                    &nbsp;
                {{- end -}}
                </td>

                {{- else if eq $paramName "stages" -}}
                  <!-- VERSION -->
                  <td>
                    {{- if ge (len $parts) 4 -}}
                      {{- trim (index $parts 3) " " -}}
                    {{- else -}}
                      &nbsp;
                    {{- end -}}
                  </td>

                {{- else -}}
                  <!-- NOTES (generic) -->
                  <td>
                    {{- $notesStr := "" -}}
                    {{- range $i, $p := $parts -}}
                      {{- if ge $i 3 -}}
                        {{- $trim := trim $p " " -}}
                        {{- if eq $notesStr "" -}}
                          {{- $notesStr = $trim -}}
                        {{- else -}}
                          {{- $notesStr = printf "%s | %s" $notesStr $trim -}}
                        {{- end -}}
                      {{- end -}}
                    {{- end -}}
                    {{- if ne $notesStr "" -}}
                      {{- $notesStr -}}
                    {{- else -}}
                      &nbsp;
                    {{- end -}}
                  </td>
                {{- end }}

              </tr>
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    </tbody>
  </table>
{{- end -}}
