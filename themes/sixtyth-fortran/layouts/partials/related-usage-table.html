{{- $currentTitle := .Title -}}
{{- $tags := .Params.tags | default (slice) -}}
{{- $paramName := "" -}}
{{- if in $tags "Animatronics" -}}
  {{- $paramName = "animatronics" -}}
{{- else if in $tags "Arcades and Attractions" -}}
  {{- $paramName = "attractions" -}}
{{- else if in $tags "Stage Variations" -}}
  {{- $paramName = "stages" -}}
{{- else if in $tags "Remodels and Initiatives" -}}
  {{- $paramName = "remodels" -}}
{{- end -}}

{{- /* Only render when the page is one of the watch-tags */ -}}
{{- if ne $paramName "" -}}
  {{- $allPages := partialCached "grab-all-wiki-articles.html" . -}}
  {{- $foundAny := false -}}

  <table class="related-usage-table" aria-label="Related usage table">
    <thead>
      <tr>
        <th>Originating article</th>
        <th>Dates</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
    {{- range $allPages -}}
      {{- $other := . -}}
      {{- if ne $other.Title $currentTitle -}}
        {{- $entries := index $other.Params $paramName -}}
        {{- if $entries -}}
          {{- range $entries -}}
            {{- $entry := . -}}
            {{- $parts := split $entry "|" -}}
            {{- $name := trim (index $parts 0) " " -}}

            {{- /* match if exactly equal or substring both ways (for forgiving matches like "Chuck E. Cheese (Cyberamic)") */ -}}
            {{- if or (eq $name $currentTitle) (strings.Contains $name $currentTitle) (strings.Contains $currentTitle $name) -}}
              {{- $foundAny = true -}}
              <tr>
                <td>
                  <a href="{{ $other.RelPermalink }}">{{ $other.Title }}</a>
                </td>
                <td>
                  {{- $lenParts := len $parts -}}
                  {{- $start := "" -}}{{- $end := "" -}}
                  {{- if ge $lenParts 2 -}}{{- $start = index $parts 1 -}}{{- end -}}
                  {{- if ge $lenParts 3 -}}{{- $end = index $parts 2 -}}{{- end -}}

                  {{- $validStart := and (ne $start "") (ne $start "0000-00-00") -}}
                  {{- $validEnd := and (ne $end "") (ne $end "0000-00-00") -}}

                  {{- if $validStart -}}
                    {{- partial "date-to-readable-date.html" $start -}}
                    {{- if $validEnd -}}
                      {{- printf " – " -}}
                      {{- partial "date-to-readable-date.html" $end -}}
                    {{- else if eq $end "0000-00-00" -}}
                      {{- printf " – Present" -}}
                    {{- end -}}
                  {{- else if $validEnd -}}
                    {{- partial "date-to-readable-date.html" $end -}}
                  {{- else if eq $end "0000-00-00" -}}
                    Present
                  {{- else -}}
                    —
                  {{- end -}}
                </td>
                <td>
                  {{- /* collect remaining parts (index >= 3) into a notes slice */ -}}
                  {{- $notes := slice -}}
                  {{- range $i, $p := $parts -}}
                    {{- if ge $i 3 -}}
                      {{- $notes = append $notes (trim $p " ") -}}
                    {{- end -}}
                  {{- end -}}

                  {{- if gt (len $notes) 0 -}}
                    {{- delimit $notes " | " -}}
                  {{- else -}}
                    &nbsp;
                  {{- end -}}
                </td>
              </tr>
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    </tbody>
  </table>

  {{- if not $foundAny -}}
    <p class="related-usage-none">No other articles reference this item in the {{ $paramName }} parameter.</p>
  {{- end -}}

{{- end -}}
