<div id="persistent-player" class="persistent-player hidden" aria-hidden="true" aria-label="Persistent media player">
  <div class="pp-header">
    <!-- title is a link back to the showtape (origin) -->
    <a id="pp-title" class="pp-title" href="#" rel="noopener noreferrer">Player</a>
    <div class="pp-controls">
      <button id="pp-close" title="Close" aria-label="Close player">âœ•</button>
    </div>
  </div>

  <div class="pp-body">
    <audio id="pp-player" controls preload="metadata" style="width:100%;">
      <source id="pp-source" src="" />
      Your browser does not support the audio element.
    </audio>
  </div>
</div>
<script>
(function () {
  const STORAGE_KEY = 'pp_state_v1';
  const byId = id => document.getElementById(id);
  const pp = byId('persistent-player');
  const player = byId('pp-player');
  const sourceEl = byId('pp-source');
  const titleEl = byId('pp-title');
  const btnClose = byId('pp-close');

  if (!pp || !player || !titleEl) return;

  const norm = s => { try { return s ? new URL(s, location.href).toString() : ''; } catch(e){ return s||''; } };

  function showPlayer(){
    pp.classList.remove('hidden');
    pp.setAttribute('aria-hidden','false');
  }

  function hidePlayer(){
    try { player.pause(); } catch(e){}
    // IMPORTANT: undefined = do not overwrite title
    saveState(undefined, { closed: true });
    pp.classList.add('hidden');
    pp.setAttribute('aria-hidden','true');
  }

  function setSource(src, cb){
    if(!src) return;
    const cur = norm(player.currentSrc || (sourceEl && sourceEl.src) || '');
    const target = norm(src);
    if(cur === target){ if(cb) cb(); return; }
    if(sourceEl){ sourceEl.src = src; } else { player.src = src; }
    player.load();
    const onLoaded = ()=>{ player.removeEventListener('loadedmetadata', onLoaded); if(cb) cb(); };
    if(player.readyState >= 1){ if(cb) cb(); }
    else { player.addEventListener('loadedmetadata', onLoaded); }
  }

  function seekAndPlay(seconds){
    try { player.currentTime = Math.max(0, seconds); }
    catch(e){
      player.addEventListener('loadedmetadata', function _once(){
        player.removeEventListener('loadedmetadata', _once);
        try { player.currentTime = seconds; } catch(e){}
      });
      return;
    }
    player.play().catch(()=>{});
  }

  function parseTimecode(tc){
    if(tc == null) return 0;
    tc = String(tc).trim();
    if(!tc) return 0;
    if(tc[0] === ':') tc = '0' + tc;
    const parts = tc.split(':').map(p => parseInt(p,10));
    if(parts.some(isNaN)) return 0;
    if(parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
    if(parts.length === 2) return parts[0]*60 + parts[1];
    return parts[0];
  }

  function safeTitle(title){
    return String(title || 'Player');
  }

  function saveState(explicitTitle, overrides = {}){
    try {
      const prev = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

      const state = Object.assign({
        src: norm(player.currentSrc || (sourceEl && sourceEl.src) || ''),
        time: Math.floor(player.currentTime || 0),
        playing: !player.paused && !player.ended,
        // ONLY update title if explicitly provided
        title: explicitTitle !== undefined
          ? safeTitle(explicitTitle)
          : prev.title,
        originUrl: prev.originUrl || '',
        closed: prev.closed || false
      }, overrides);

      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch(e){}
  }

  function playTrackFromElement(el){
    if(!el) return;
    const start = parseTimecode(el.dataset.start);
    const src = el.dataset.src || '';
    const pageTitle = safeTitle(document.title);
    const origin = String(window.location.href);

    titleEl.textContent = pageTitle;
    titleEl.href = origin;

    showPlayer();

    const cur = norm(player.currentSrc || (sourceEl && sourceEl.src) || '');
    const target = norm(src);

    if(cur === target) seekAndPlay(start);
    else setSource(src, () => seekAndPlay(start));

    saveState(pageTitle, { originUrl: origin, closed: false });
    updateUrlParams(src, Math.floor(start));
  }

  document.addEventListener('click', function(ev){
    const el = ev.target.closest && ev.target.closest('.track');
    if(!el) return;
    if(el.closest('a')) ev.preventDefault();
    playTrackFromElement(el);
  }, false);

  function loadState(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const state = JSON.parse(raw);
      if(!state) return;

      const { src, time, playing, title, originUrl, closed } = state;

      if(title) titleEl.textContent = safeTitle(title);
      if(originUrl) titleEl.href = originUrl;

      if(closed || !src) return;

      setSource(src, () => {
        if(typeof time === 'number'){
          try { player.currentTime = time; }
          catch(e){
            player.addEventListener('loadedmetadata', function _once(){
              player.removeEventListener('loadedmetadata', _once);
              player.currentTime = time;
            });
          }
        }
        if (playing) {
        player.play().catch(()=>{});
        }
      });

    } catch(e){}
  }

  function updateUrlParams(src, t){
    try {
      const url = new URL(window.location);
      if(src) url.searchParams.set('src', src);
      if(typeof t === 'number') url.searchParams.set('t', t);
      window.history.replaceState({}, '', url);
    } catch(e){}
  }

  function updateActiveTrack(){
    if(pp.classList.contains('hidden')) return;
    const current = player.currentTime;
    if(isNaN(current)) return;

    const tracks = document.querySelectorAll('.track[data-start]');
    let active = null;

    tracks.forEach(track => {
      const start = parseTimecode(track.dataset.start);
      if(start <= current && (!active || start > parseTimecode(active.dataset.start))){
        active = track;
      }
    });

    document.querySelectorAll('.track.active').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.active-parent').forEach(el => el.classList.remove('active-parent'));

    if(!active) return;
    active.classList.add('active');

    let parent = active.parentElement;
    while(parent){
      if(parent.classList?.contains('segment') || parent.classList?.contains('medley')){
        parent.classList.add('active-parent');
      }
      parent = parent.parentElement;
    }
  }

  btnClose.addEventListener('click', hidePlayer);

  player.addEventListener('timeupdate', throttle(() => {
    saveState();
    updateActiveTrack();
  }, 800));

  player.addEventListener('play', () => saveState());
  player.addEventListener('pause', () => saveState());
  window.addEventListener('beforeunload', () => saveState());

  (function init(){
    const params = new URLSearchParams(window.location.search);
    const qsrc = params.get('src');
    const qt = params.get('t');

    if(qsrc){
      const start = qt ? parseFloat(qt) : 0;
      setSource(qsrc, () => {
        if(!isNaN(start)) try{ player.currentTime = start; }catch(e){}
        showPlayer();
      });
      titleEl.textContent = safeTitle(document.title);
      titleEl.href = String(window.location.href);
      saveState(document.title, { originUrl: String(window.location.href), closed: false });
    } else {
      loadState();
    }
  })();

  function throttle(fn, wait){
    let last = 0;
    return function(){
      const now = Date.now();
      if(now - last >= wait){
        last = now;
        fn.apply(this, arguments);
      }
    };
  }
})();
</script>
