{{- $currentTitle := .Title -}}
{{- $tags := .Params.tags | default (slice) -}}
{{- $paramName := "" -}}

{{- if in $tags "Animatronics" -}}
  {{- $paramName = "animatronics" -}}
{{- else if in $tags "Arcades and Attractions" -}}
  {{- $paramName = "attractions" -}}
{{- else if in $tags "Stage Variations" -}}
  {{- $paramName = "stages" -}}
{{- else if in $tags "Remodels and Initiatives" -}}
  {{- $paramName = "remodels" -}}
{{- end -}}

{{- if ne $paramName "" -}}
  {{- $index := index site.Data "locations-index" -}}

  {{- $mapKey := printf "%s|%s" $paramName $currentTitle -}}
  {{- $entriesList := index $index $mapKey | default (slice) -}}
  {{- $sorted := sort $entriesList "sort" -}}

  {{- if gt (len $sorted) 0 -}}
    <h2>Installations</h2>
    <table class="related-usage-table" aria-label="Related usage table">
      <thead>
        <tr>
          <th>Location</th>
          <th>{{ if eq $paramName "remodels" }}Installed{{ else }}Operating Dates{{ end }}</th>
          {{- if eq $paramName "stages" -}}
            <th>Version</th>
          {{- else if eq $paramName "animatronics" -}}
            <th>Serial Number</th>
            <th>Notes</th>
          {{- else if eq $paramName "remodels" -}}
            {{/* no extra */}}
          {{- else -}}
            <th>Notes</th>
          {{- end -}}
        </tr>
      </thead>
      <tbody>
      {{- range $sorted -}}
        {{- $entry := . -}}
        {{- $parts := index $entry "parts" | default (slice) -}}
        {{- $pageGet := index $entry "page_get" | default "" -}}
        {{- $pagePath := index $entry "page_path" | default "" -}}
        {{- $pageTitle := index $entry "page_title" | default "" -}}

        {{/* Resolve Hugo page object for nicer link/title if possible.
            Initialize $other to empty string (falsey), then assign page object if found. */}}
        {{- $other := "" -}}
        {{- if ne $pageGet "" -}}
          {{- with site.GetPage $pageGet -}}
            {{- $other = . -}}
          {{- end -}}
        {{- end -}}

        {{- /* Fallbacks for link and title */ -}}
        {{- $otherTitle := cond (ne $other "") (printf "%s" $other.Title) $pageTitle -}}
        {{- $otherLink := "#" -}}
        {{- if ne $other "" -}}
          {{- $otherLink = $other.RelPermalink -}}
        {{- else if ne $pageGet "" -}}
          {{- /* assume a site-relative section path was provided (e.g. "wiki/Some_Page") */ -}}
          {{- $otherLink = printf "/%s/" $pageGet -}}
        {{- else if ne $pagePath "" -}}
          {{- /* convert "content/..." path to site URL (strip content/ and extension) */ -}}
          {{- $clean := replaceRE "^content/" "" (replaceRE "\\.(md|markdown|mdown)$" "" $pagePath) -}}
          {{- $otherLink = printf "/%s/" $clean -}}
        {{- end -}}

        <tr>
          <td><a href="{{ $otherLink }}">{{ $otherTitle }}</a></td>

          <td>
            {{- $start := "" -}}
            {{- $end := "" -}}
            {{- if ge (len $parts) 2 -}}{{- $start = index $parts 1 -}}{{- end -}}
            {{- if ge (len $parts) 3 -}}{{- $end = index $parts 2 -}}{{- end -}}

            {{- if eq $paramName "remodels" -}}
              {{- partial "Readable_Date.html" (dict "date" $start "presentOnEmpty" false) -}}
            {{- else -}}
              {{- partial "Readable_Date.html" (dict "date" $start "presentOnEmpty" false) -}}
              {{- " - " -}}
              {{- partial "Readable_Date.html" (dict "date" $end "presentOnEmpty" true) -}}
            {{- end -}}
          </td>

          {{- if eq $paramName "animatronics" -}}
            <td>
              {{- if ge (len $parts) 4 -}}
                {{- index $parts 3 | printf "%s" | plainify -}}
              {{- else -}}
                &nbsp;
              {{- end -}}
            </td>

            <td>
              {{- $animNotes := slice -}}
              {{- range $i, $p := $parts -}}
                {{- if ge $i 4 -}}
                  {{- $animNotes = $animNotes | append (printf "%s" $p | plainify) -}}
                {{- end -}}
              {{- end -}}
              {{- if gt (len $animNotes) 0 -}}
                {{- delimit $animNotes " | " -}}
              {{- else -}}
                &nbsp;
              {{- end -}}
            </td>

          {{- else if eq $paramName "stages" -}}
            <td>
              {{- if ge (len $parts) 4 -}}
                {{- index $parts 3 | printf "%s" | plainify -}}
              {{- else -}}
                &nbsp;
              {{- end -}}
            </td>

          {{- else if eq $paramName "remodels" -}}
            {{- /* no extra columns */ -}}
          {{- else -}}
            <td>
              {{- $notesArr := slice -}}
              {{- range $i, $p := $parts -}}
                {{- if ge $i 3 -}}
                  {{- $notesArr = $notesArr | append (printf "%s" $p | plainify) -}}
                {{- end -}}
              {{- end -}}
              {{- if gt (len $notesArr) 0 -}}
                {{- delimit $notesArr " | " -}}
              {{- else -}}
                &nbsp;
              {{- end -}}
            </td>
          {{- end }}

        </tr>
      {{- end -}}
      </tbody>
    </table>
  {{- end -}}
{{- end -}}
