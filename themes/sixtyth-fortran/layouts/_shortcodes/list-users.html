{{- $discourseUsers := site.Data.discourse_users -}}
{{- $userPages := where site.RegularPages "Section" "users" -}}
{{- $processedUsernames := dict -}}
{{- $finalUserList := slice -}}

{{- /* 1. Process Discourse Users first */ -}}
{{- range $discourseUsers -}}
    {{- $username := .username -}}
    {{- $displayName := .name | default .username -}}
    {{- $profileUrl := "" -}}
    {{- $avatarUrl := "" -}}

    {{- if .avatar_template -}}
      {{- $avatarUrl = replace (printf "https://forum.cheeseepedia.org%s" .avatar_template) "{size}" "48" -}}
      {{- $profileUrl = printf "https://forum.cheeseepedia.org/u/%s" .username -}}
    {{- end -}}

    {{- $localPage := where $userPages "Title" $displayName -}}
    {{- if gt (len $localPage) 0 -}}
        {{- $profileUrl = (index $localPage 0).RelPermalink -}}
    {{- end -}}

  {{- $userData := dict 
      "displayName" $displayName 
      "username" $username
      "profileUrl" $profileUrl
      "avatarUrl" $avatarUrl
      "gradientStart" .gradient_start
      "gradientEnd" .gradient_end
      "rank" .rank
      "count" .contribution_count
  -}}
    {{- $finalUserList = $finalUserList | append $userData -}}
    {{- $processedUsernames = merge $processedUsernames (dict (lower $displayName) true) -}}
{{- end -}}

<div class="user-directory">
    <div class="predef-tags contributor-tags">
        <div class="predef-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
            {{- range sort $finalUserList "count" "desc" -}}
            <a href="{{ .profileUrl }}" 
               class="predef-tag-btn contributor-btn"
               title="{{ .rank }}{{ if gt .count 0 }} (+{{ .count }}){{ end }}"
               style="background: linear-gradient(0deg, {{ .gradientStart }}, {{ .gradientEnd }});">
                
                {{- if .avatarUrl -}}
                    <img src="{{ .avatarUrl }}" alt="{{ .displayName }}" class="contributor-avatar" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px;">
                {{- end -}}
                
                {{ .displayName }}
                
                {{- if gt .count 0 -}}
                    <sup style="margin-left: 4px; font-size: 0.7em;">(+{{ .count }})</sup>
                {{- end -}}
            </a>
            {{- end -}}
        </div>
    </div>
</div>